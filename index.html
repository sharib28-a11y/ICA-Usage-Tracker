<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICA Cloud Tracker - Live Sync</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #0f172a; color: #e2e8f0; }
        .container { max-width: 1200px; margin: auto; background: #1e293b; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #334155; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #3b82f6; padding-bottom: 15px; }
        h2, h3 { color: #3b82f6; margin-top: 0; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: #334155; color: #94a3b8; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .content { display: none; }
        .content.active { display: block; }
        .header-controls { margin-bottom: 20px; padding: 15px; background: #0f172a; border-radius: 8px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; border: 1px solid #334155; }
        label { font-weight: bold; color: #3b82f6; font-size: 0.85em; }
        input { background: #1e293b; border: 1px solid #334155; color: white; padding: 8px; border-radius: 6px; outline: none; width: 140px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; background: #1e293b; }
        th, td { border: 1px solid #334155; padding: 12px; text-align: center; }
        th { background-color: #3b82f6; color: white; }
        tr:nth-child(even) { background: #1a2233; }
        .status-under { color: #f87171; font-weight: bold; background: rgba(248, 113, 113, 0.1) !important; }
        .status-met { color: #4ade80; font-weight: bold; background: rgba(74, 222, 128, 0.1) !important; }
        .status-over { color: #60a5fa; font-weight: bold; background: rgba(96, 165, 250, 0.1) !important; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .chart-box { height: 320px; background: #0f172a; border: 1px solid #334155; padding: 15px; border-radius: 8px; }
        .controls { display: flex; gap: 10px; margin-top: 20px; }
        button { padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-reset { background: #ef4444; color: white; opacity: 0.7; }
        #sync-indicator { font-size: 0.75em; padding: 4px 8px; border-radius: 4px; background: #064e3b; color: #34d399; margin-left: auto; }

        @media print {
            .tabs, .btn-reset, .header-controls small, .controls button:not(.btn-blue) { display: none !important; }
            body { background: white; color: black; }
            .container { background: white; color: black; border: none; box-shadow: none; }
            th { background: #3b82f6 !important; color: white !important; -webkit-print-color-adjust: exact; }
			/* Show both sections for the PDF */
			#details, #admin { display: block !important; }
			/* Hide the Range Filter inputs but keep the results */
			.header-controls input, .header-controls button { display: none; }
			.container { width: 100%; border: none; }
			input { border: none !important; color: black !important;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="report-header">
        <div>
            <h2 style="margin:0;">ICA Cloud Tracker</h2>
            <small style="color: #94a3b8;">Real-time Collaborative Dashboard</small>
        </div>
        <div id="sync-indicator">‚óè Live Cloud Sync Active</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('details', this)">Details Entry</button>
        <button class="tab-btn" onclick="showTab('admin', this)">Admin Dashboard</button>
    </div>

    <div id="details" class="content active">
        <div class="header-controls">
            <div>
                <label>Week Ending (Sat):</label>
                <input type="date" id="weekEnding" onchange="handleDateChange()">
            </div>
            <div>
                <label>Target (Hrs):</label>
                <input type="number" id="targetHrs" style="width: 60px;" onchange="saveSettings()">
            </div>
			<div>
            <button onclick="exportCSV()" class="btn-green" style="margin-left: 20px;">üìä Export to Excel</button>
			<button onclick="document.getElementById('csvImport').click()" class="btn-blue" style="margin-left: 10px;">üì• Import CSV</button>
			<input type="file" id="csvImport" accept=".csv" style="display:none" onchange="importCSV(this)">
			</div>
			<div>
			<button onclick="copyNamesFromPreviousWeek()" class="btn-blue" style="background: #6366f1;">üìã Auto-Fill Username</button>
			</div>
        </div>
        
		<h3>Weekly Minute Log</h3>
        <table>
            <thead><tr><th>User Name</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th></tr></thead>
            <tbody id="user-rows"></tbody>
        </table>
		<button onclick="addNewUser()" class="btn-blue" style="margin-top: 15px; background: #10b981;">‚ûï Add New User</button>
    </div>

    <div id="admin" class="content">
        <div class="charts-grid">
            <div class="chart-box"><canvas id="usageChart"></canvas></div>
            <div class="chart-box"><canvas id="trendChart"></canvas></div>
        </div>
        <h3>Summary for: <span id="report-date-display" style="color: #60a5fa;"></span></h3>
        <table id="summaryTable">
            <thead><tr><th>User</th><th>Total Hours</th><th>Avg/Day</th><th>Status</th></tr></thead>
            <tbody id="admin-rows"></tbody>
        </table>
		<div>
			<h3>Historical Performance</h3>
			<table id="historyTable">
				<thead>
					<tr>
						<th>Week Ending</th>
						<th>Total Team Hrs</th>
						<th>Avg Team Hrs</th>
						<th>Top Performer (Avg)</th>
					</tr>
				</thead>
				<tbody id="history-rows"></tbody>
			</table>
			<br>
		</div>
		<div class="header-controls" style="margin-top: 20px;">
			<h3 style="width: 100%; margin-bottom: 10px;">Range Summary</h3>
			<div>
				<label>From:</label>
				<input type="date" id="rangeFrom">
			</div>
			<div>
				<label>To:</label>
				<input type="date" id="rangeTo">
			</div>
			<button class="btn-blue" onclick="calculateRangeStats()">Calculate Range</button>
			<div id="rangeResult" style="margin-left: 20px; font-weight: bold; color: #4ade80;"></div>
		</div>
		<div class="controls">
            <button class="btn-blue" onclick="window.print()">üñ®Ô∏è Print PDF Report</button>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION ---
    // REPLACE THESE WITH YOUR KEYS FROM FIREBASE CONSOLE
    const firebaseConfig = {
        apiKey: "AIzaSyD_zAFAeNLkTk3ZpAz0PsUIyKCGNDcIl2g",
		authDomain: "ica-usage-tracker.firebaseapp.com",
		databaseURL: "https://ica-usage-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
		projectId: "ica-usage-tracker",
		storageBucket: "ica-usage-tracker.firebasestorage.app",
		messagingSenderId: "387548529515",
		appId: "1:387548529515:web:ae5fb16f2bd4f70f44422e",
		measurementId: "G-TX8RL8KBZ5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. APP STATE ---
    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
    let usageChart, trendChart;
    let weekEndingDate = "";
    let targetHrs = 10;
    let teamSize = 10;
    let appData = [];
    let fullVault = {}; // Local cache of all weeks for history

    // --- 3. INITIALIZATION ---
    window.onload = () => {
        restrictDatePicker();
        weekEndingDate = getSaturday(new Date());
        document.getElementById('weekEnding').value = weekEndingDate;
        
        // Load Global Settings Once
        db.ref('settings').on('value', (snap) => {
            const settings = snap.val();
            if(settings) {
                targetHrs = settings.targetHrs;
                teamSize = settings.teamSize;
                document.getElementById('targetHrs').value = targetHrs;
                document.getElementById('teamSize').value = teamSize;
            }
            loadWeekData(weekEndingDate);
        });

        // Listen for all vault changes to build history
        db.ref('vault').on('value', (snap) => {
            fullVault = snap.val() || {};
        });
    };

    function getSaturday(d) {
        let dt = new Date(d);
        const day = dt.getDay();
        dt.setDate(dt.getDate() + ((day === 0) ? -1 : (6 - day)));
        return dt.toISOString().split('T')[0];
    }

    function restrictDatePicker() {
        document.getElementById('weekEnding').max = getSaturday(new Date());
    }

    // --- 4. DATA SYNC LOGIC ---
    function loadWeekData(dateStr) {
        const key = getSaturday(dateStr);
        weekEndingDate = key;
        
        // Listen for real-time updates for THIS week
        db.ref('vault/' + key).on('value', (snap) => {
            const cloudData = snap.val();
            if(cloudData) {
                appData = cloudData;
            } else {
                initializeNewWeek();
            }
            renderDetails();
            if(document.getElementById('admin').classList.contains('active')) {
                renderAdmin();
                updateCharts();
            }
        });
    }

    function initializeNewWeek() {
    // Default to 5 users for a fresh week
    appData = [];
    for (let i = 0; i < 5; i++) {
        appData.push({ name: `User ${i + 1}`, mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 });
    }
    saveToCloud();
}
	function addNewUser() {
    const nextIndex = appData.length + 1;
    appData.push({ name: `User ${nextIndex}`, mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 });
    saveToCloud();
    renderDetails();
}

function removeUser(index) {
    if(confirm("Are you sure you want to remove this user?")) {
        appData.splice(index, 1);
        saveToCloud();
        renderDetails();
    }
}
	
    function saveToCloud() {
        const key = getSaturday(weekEndingDate);
        db.ref('vault/' + key).set(appData);
    }

    function saveSettings() {
        targetHrs = document.getElementById('targetHrs').value;
        teamSize = document.getElementById('teamSize').value;
        db.ref('settings').set({ targetHrs, teamSize });
    }

    function updateTeamSize() {
        teamSize = parseInt(document.getElementById('teamSize').value);
        if (appData.length < teamSize) {
            while (appData.length < teamSize) appData.push({ name: `User ${appData.length + 1}`, mon: 0, tue: 0, wed: 0, thu: 0, fri: 0 });
        } else {
            appData = appData.slice(0, teamSize);
        }
        saveSettings();
        saveToCloud();
    }

    function handleDateChange() {
    const newDate = document.getElementById('weekEnding').value;
    const oldKey = getSaturday(weekEndingDate);
    
    // Detach old listener
    db.ref('vault/' + oldKey).off();
    
    // Update the global date variable
    weekEndingDate = getSaturday(newDate);
    
    // Load the new week
    loadWeekData(weekEndingDate);
}

    function updateUser(idx, field, val) {
        appData[idx][field] = field === 'name' ? val : (parseFloat(val) || 0);
        saveToCloud();
    }

    // --- 5. UI RENDERING ---
    function renderDetails() {
    const tbody = document.getElementById('user-rows');
    tbody.innerHTML = appData.map((u, i) => `
        <tr>
            <td><input type="text" value="${u.name}" onchange="updateUser(${i}, 'name', this.value)"></td>
            ${days.map(d => `<td><input type="number" value="${u[d]}" onchange="updateUser(${i}, '${d}', this.value)"></td>`).join('')}
            <td><button onclick="removeUser(${i})" style="background:none; color:#ef4444; cursor:pointer; font-size:1.2em;">üóëÔ∏è</button></td>
        </tr>`).join('');
}

    function renderAdmin() {
    document.getElementById('report-date-display').innerText = weekEndingDate;
    
    // Render Current Week Summary
    document.getElementById('admin-rows').innerHTML = appData.map(u => {
        const total = days.reduce((s, d) => s + u[d], 0) / 60;
        let css = total < targetHrs ? "status-under" : "status-met";
        return `<tr class="${css}"><td>${u.name}</td><td>${total.toFixed(2)}</td><td>${(total/5).toFixed(2)}</td>
        <td>${total < targetHrs ? "Under" : "Met"}</td></tr>`;
    }).join('');

    // Render History Table
    const historyBody = document.getElementById('history-rows');
    const sortedWeeks = Object.keys(fullVault).sort().reverse();
    
    historyBody.innerHTML = sortedWeeks.map(week => {
        const weekUsers = fullVault[week];
        const totalMinutes = weekUsers.reduce((acc, u) => acc + days.reduce((s, d) => s + u[d], 0), 0);
        const totalHrs = totalMinutes / 60;
        const avgHrs = totalHrs / weekUsers.length;
        
        // Find Top Performer
        let topUser = { name: 'N/A', avg: 0 };
        weekUsers.forEach(u => {
            const uAvg = (days.reduce((s, d) => s + u[d], 0) / 60) / 5;
            if(uAvg > topUser.avg) topUser = { name: u.name, avg: uAvg };
        });

        return `<tr>
            <td>${week}</td>
            <td>${totalHrs.toFixed(2)}</td>
            <td>${avgHrs.toFixed(2)}</td>
            <td>${topUser.name} (${topUser.avg.toFixed(2)})</td>
        </tr>`;
    }).join('');
}

    function updateCharts() {
        const ctxB = document.getElementById('usageChart').getContext('2d');
        if(usageChart) usageChart.destroy();
        usageChart = new Chart(ctxB, { type:'bar', data: { labels: appData.map(u=>u.name), datasets: [{label:'Hours', data: appData.map(u=>days.reduce((s,d)=>s+u[d],0)/60), backgroundColor:'#3b82f6'}] }, options: { maintainAspectRatio: false } });
        
        const ctxL = document.getElementById('trendChart').getContext('2d');
        if(trendChart) trendChart.destroy();
        const keys = Object.keys(fullVault).sort();
        trendChart = new Chart(ctxL, { type:'line', data: { labels: keys, datasets: [{label:'Team Total', data: keys.map(x=>fullVault[x].reduce((a,u)=>a+days.reduce((s,d)=>s+u[d],0),0)/60), borderColor:'#60a5fa'}] }, options: { maintainAspectRatio: false } });
    }

    function showTab(t, b) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active'); b.classList.add('active');
        if(t === 'admin') { renderAdmin(); updateCharts(); }
    }

    function exportCSV() {
        let csv = "User Name,Mon,Tue,Wed,Thu,Fri,Total Hours\n";
        appData.forEach(u => {
            const total = (days.reduce((s, d) => s + u[d], 0) / 60).toFixed(2);
            csv += `${u.name},${u.mon},${u.tue},${u.wed},${u.thu},${u.fri},${total}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `ICA_Report_${weekEndingDate}.csv`; a.click();
    }
	
	function importCSV(input) {
    const file = input.files[0];
    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            const importedData = results.data.map(row => ({
                name: row["User Name"] || "Unknown",
                mon: parseFloat(row["Mon"]) || 0,
                tue: parseFloat(row["Tue"]) || 0,
                wed: parseFloat(row["Wed"]) || 0,
                thu: parseFloat(row["Thu"]) || 0,
                fri: parseFloat(row["Fri"]) || 0
            }));
            
            if(confirm(`Import ${importedData.length} users? This will overwrite current week data.`)) {
                appData = importedData;
                teamSize = importedData.length;
                document.getElementById('teamSize').value = teamSize;
                saveSettings();
                saveToCloud();
                renderDetails();
            }
        }
    });
	}
	function calculateRangeStats() {
    const from = document.getElementById('rangeFrom').value;
    const to = document.getElementById('rangeTo').value;
    const resultDiv = document.getElementById('rangeResult');

    if (!from || !to) {
        alert("Please select both start and end dates.");
        return;
    }

    let totalHrs = 0;
    let weekCount = 0;

    // Iterate through the cloud vault
    Object.keys(fullVault).forEach(weekDate => {
        if (weekDate >= from && weekDate <= to) {
            const weekUsers = fullVault[weekDate];
            const weekMinutes = weekUsers.reduce((acc, u) => acc + days.reduce((s, d) => s + u[d], 0), 0);
            totalHrs += (weekMinutes / 60);
            weekCount++;
        }
    });

    if (weekCount === 0) {
        resultDiv.innerText = "No data found for this range.";
    } else {
        const avg = totalHrs / weekCount;
        resultDiv.innerHTML = `Total: ${totalHrs.toFixed(2)} hrs | Weekly Avg: ${avg.toFixed(2)} hrs`;
    }
}
	function copyNamesFromPreviousWeek() {
    const currentSat = new Date(weekEndingDate);
    const prevSatDate = new Date(currentSat);
    prevSatDate.setDate(prevSatDate.getDate() - 7);
    const prevKey = prevSatDate.toISOString().split('T')[0];

    db.ref('vault/' + prevKey).once('value', (snap) => {
        const prevData = snap.val();
        if (!prevData) {
            alert("No data found for the previous week (" + prevKey + ")");
            return;
        }

        if (confirm(`Copy names from ${prevData.length} users from last week?`)) {
            appData = prevData.map(oldUser => ({
                name: oldUser.name,
                mon: 0, tue: 0, wed: 0, thu: 0, fri: 0
            }));
            saveToCloud();
            renderDetails();
        }
    });
}

    function resetCloudData() { if(confirm("Wipe all cloud records?")) db.ref('/').remove(); }
</script>
</body>
</html>